# 核心模块开发指南

## 模块概述

核心模块包含项目的基础设施层和应用层组件，为整个系统提供基础功能支持。主要包含以下几个关键模块：

1. **公共工具模块** (common/)
2. **分析器模块** (analyzers/) 
3. **国际化模块** (i18n/)
4. **异常处理模块**

## 1. 公共工具模块 (common/)

### 1.1 语言检测器 (language_detector.py)

#### 功能说明
根据文件扩展名和内容特征检测编程语言类型。

#### 实现步骤

**步骤1**: 创建语言类型枚举和常量定义
- 定义 `LanguageType` 枚举类
- 创建支持的语言类型常量
- 建立文件扩展名到语言的映射关系

**步骤2**: 实现语言检测器接口
- 创建 `LanguageDetector` 抽象基类
- 定义 `detect_language(file_path: str) -> LanguageType` 方法
- 定义 `is_supported_file(file_path: str) -> bool` 方法

**步骤3**: 实现默认检测器
- 基于文件扩展名的基础检测
- 处理特殊情况（如 .tsx, .jsx 等）
- 添加内容检测功能（可选高级特性）

#### 测试验证方法
- 创建测试文件 `test_language_detector.py`
- 准备各种语言的示例文件
- 验证检测结果的准确性
- 测试边界情况（无扩展名、未知扩展名等）

**测试用例示例**:
- 测试 `.py` 文件检测为 Python
- 测试 `.js` 文件检测为 JavaScript  
- 测试 `.tsx` 文件检测为 TypeScript
- 测试不支持的文件类型返回 `UNSUPPORTED`

### 1.2 文件工具 (file_utils.py)

#### 功能说明
提供文件和目录操作的工具函数，包括文件搜索、路径处理、模式匹配等。

#### 实现步骤

**步骤1**: 实现基础文件操作
- `read_file_content(file_path: str) -> str` - 读取文件内容
- `get_file_info(file_path: str) -> FileInfo` - 获取文件信息
- `is_text_file(file_path: str) -> bool` - 判断是否为文本文件

**步骤2**: 实现文件搜索功能
- `find_source_files()` - 搜索源代码文件
- 支持包含/排除模式匹配
- 实现进度回调机制
- 处理默认排除目录 (node_modules, .git, vendor等)

**步骤3**: 实现路径处理工具
- `normalize_path()` - 路径标准化
- `get_relative_path()` - 获取相对路径
- `match_pattern()` - 模式匹配工具

#### 测试验证方法
- 创建测试目录结构
- 测试文件搜索功能的准确性
- 验证包含/排除模式的正确性
- 测试大目录的搜索性能

### 1.3 常量定义 (constants.py)

#### 实现内容
- 支持的编程语言枚举
- 默认排除目录列表
- 质量评级常量
- 配置默认值

### 1.4 异常定义 (exceptions.py)

#### 实现内容
- `FuckUCodeException` - 基础异常类
- `ParseError` - 解析错误
- `AnalysisError` - 分析错误
- `FileNotFoundError` - 文件不存在错误
- `UnsupportedLanguageError` - 不支持的语言错误

## 2. 分析器模块 (analyzers/)

### 2.1 分析器接口设计 (interfaces.py)

#### 实现步骤

**步骤1**: 定义核心数据模型
- `AnalysisResult` - 分析结果模型
- `MetricResult` - 指标结果模型  
- `FileAnalysisResult` - 文件分析结果模型

**步骤2**: 定义分析器接口
- `Analyzer` 抽象基类
- 定义分析方法签名
- 定义配置和状态管理方法

### 2.2 基础分析器 (base_analyzer.py)

#### 功能说明
提供分析器的基础实现和通用功能。

#### 实现步骤

**步骤1**: 实现基础分析器框架
- 初始化方法
- 配置管理（语言设置、静默模式等）
- 依赖注入支持

**步骤2**: 实现通用分析逻辑
- 文件类型检测
- 解析器选择
- 指标应用流程
- 结果聚合逻辑

**步骤3**: 实现进度报告机制
- 进度回调支持
- 状态通知
- 错误处理和恢复

#### 测试验证方法
- 创建mock解析器和指标
- 测试基础分析流程
- 验证错误处理机制
- 测试进度报告功能

### 2.3 代码分析器 (code_analyzer.py)

#### 功能说明
主要的代码分析实现，集成解析器和指标系统。

#### 实现步骤

**步骤1**: 实现单文件分析
- 文件内容读取
- 解析器创建和调用
- 指标计算和聚合
- 结果对象构建

**步骤2**: 实现目录分析
- 文件搜索和过滤
- 并发分析处理
- 进度报告
- 结果合并

**步骤3**: 实现结果处理
- 总体评分计算
- 指标平均值计算
- 问题文件识别
- 统计信息生成

#### 测试验证方法
- 准备各种类型的测试文件
- 测试单文件分析功能
- 测试目录分析功能  
- 验证并发处理的正确性
- 测试结果聚合的准确性

**测试场景**:
- 分析单个Python文件
- 分析包含多种语言的项目目录
- 测试文件过滤功能
- 验证错误处理（解析失败、文件读取错误等）

## 3. 国际化模块 (i18n/)

### 3.1 翻译器 (translator.py)

#### 功能说明
提供多语言支持，管理翻译文本和语言切换。

#### 实现步骤

**步骤1**: 定义翻译器接口
- `Translator` 抽象基类
- `translate(key: str, **kwargs) -> str` 方法
- `set_language(language: str)` 方法

**步骤2**: 实现翻译器
- 翻译文本加载
- 键值查找和替换
- 参数插值支持
- 缺失翻译处理

#### 测试验证方法
- 测试翻译文本查找
- 验证参数插值功能
- 测试语言切换
- 验证缺失翻译的降级处理

### 3.2 语言包 (zh_cn.py, en_us.py)

#### 实现内容
- 应用名称和描述
- 指标名称和描述
- 质量等级文本
- 错误信息文本
- CLI帮助文本

## 4. 实现优先级和里程碑

### 第一阶段：基础设施
1. 实现常量定义和异常类
2. 实现语言检测器
3. 实现基础文件工具
4. 创建对应的单元测试

### 第二阶段：分析器框架
1. 实现分析器接口和数据模型
2. 实现基础分析器
3. 创建mock组件用于测试
4. 验证分析流程

### 第三阶段：国际化支持
1. 实现翻译器
2. 添加中英文语言包
3. 集成到分析器中
4. 测试多语言切换

## 5. 开发注意事项

### 5.1 代码质量要求
- 使用类型提示 (Type Hints)
- 添加详细的文档字符串
- 遵循PEP 8代码规范
- 保持函数和类的单一职责

### 5.2 错误处理策略
- 使用具体的异常类型
- 提供详细的错误信息
- 实现优雅降级
- 记录调试信息

### 5.3 性能考虑
- 避免重复的文件读取
- 合理使用缓存
- 控制内存使用
- 考虑并发处理的线程安全

### 5.4 测试要求
- 每个公共方法都要有测试用例
- 测试覆盖率不低于90%
- 包含边界情况测试
- 准备充足的测试数据

## 6. 验证检查清单

完成核心模块开发后，请验证以下功能：

### 基础功能验证
- [ ] 语言检测器能正确识别各种文件类型
- [ ] 文件搜索功能能正确过滤文件
- [ ] 翻译器能正确处理中英文切换
- [ ] 异常处理机制工作正常

### 集成测试验证
- [ ] 分析器能成功创建和配置
- [ ] 单文件分析流程完整可用
- [ ] 目录分析功能正常工作
- [ ] 进度报告机制正确反馈

### 性能测试验证
- [ ] 大目录搜索性能可接受
- [ ] 内存使用控制在合理范围
- [ ] 错误恢复机制有效
- [ ] 并发处理稳定可靠

完成核心模块后，可以继续实现解析器模块和指标系统。